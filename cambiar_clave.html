<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cambiar Clave</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f1f1f1; margin:0; padding:0; }
    .wrap { max-width:520px; margin:10px auto; padding:18px; text-align:center; }
    h1 { margin: 6px 0 20px; font-size:22px; }
    input {
      width:100%; padding:14px; margin:10px 0;
      border:1px solid #cfcfcf; border-radius:8px; font-size:16px;
    }
    .btn {
      width:100%; padding:16px; margin:14px 0; font-size:18px;
      border-radius:10px; border:1px solid #cfcfcf; background:#e8e8e8; cursor:pointer;
    }
    .btn:active { transform: translateY(1px); }
    .btn-danger { background:#ffb3b3; border-color:#e6a0a0; }
    .msg { font-size:15px; margin-top:10px; }
  </style>

  <!-- ✅ Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
  <script src="firebaseConfig.js"></script>
</head>
<body>

  <div class="wrap">
    <h1>Cambiar Clave</h1>

    <input id="claveActual" type="password" placeholder="Clave Actual">
    <input id="claveNueva" type="password" placeholder="Nueva Clave">
    <input id="claveConfirm" type="password" placeholder="Confirmar Nueva Clave">

    <button id="btnCambiar" class="btn">Guardar Cambios</button>
    <button id="btnVolver" class="btn btn-danger">Volver</button>

    <div id="mensaje" class="msg"></div>
  </div>

  <script>
    const auth = firebase.auth();

    // Si no hay sesión → fuera
    if (!localStorage.getItem("usuario")) {
      window.location.href = "index.html";
    }

    const claveActual = document.getElementById("claveActual");
    const claveNueva = document.getElementById("claveNueva");
    const claveConfirm = document.getElementById("claveConfirm");
    const btnCambiar = document.getElementById("btnCambiar");
    const btnVolver = document.getElementById("btnVolver");
    const mensaje = document.getElementById("mensaje");

    function mostrar(msj, color="red") {
      mensaje.style.color = color;
      mensaje.textContent = msj;
    }

    btnCambiar.addEventListener("click", async () => {
      const actual = claveActual.value.trim();
      const nueva = claveNueva.value.trim();
      const confirm = claveConfirm.value.trim();

      if (!actual || !nueva || !confirm) return mostrar("Completa todos los campos");
      if (nueva.length < 6) return mostrar("La nueva clave debe tener mínimo 6 caracteres");
      if (nueva !== confirm) return mostrar("La nueva clave no coincide con la confirmación");

      const user = auth.currentUser;
      if (!user) return mostrar("Sesión inválida");

      const cred = firebase.auth.EmailAuthProvider.credential(user.email, actual);

      try {
        // ✅ Validar clave actual
        await user.reauthenticateWithCredential(cred);

        // ✅ Cambiar clave
        await user.updatePassword(nueva);

        mostrar("✅ Clave actualizada con éxito", "green");

        setTimeout(() => {
          auth.signOut();
          localStorage.clear();
          window.location.href = "index.html";
        }, 1500);

      } catch (e) {
        if (e.code === "auth/wrong-password") return mostrar("❌ La clave actual es incorrecta");
        mostrar("❌ Error: " + e.message);
      }
    });

    btnVolver.addEventListener("click", () => {
      window.location.href = "dashboard.html";
    });
  </script>
</body>
</html>
