<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cambiar contraseña</title>

<script type="module">
    import { db } from "./js/firebase.js";
    import { doc, getDoc, updateDoc } 
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    document.addEventListener("DOMContentLoaded", () => {

        const usuario = localStorage.getItem("usuario");

        if (!usuario) {
            alert("Sesión expirada");
            window.location.href = "index.html";
            return;
        }

        const inputActual = document.getElementById("claveActual");
        const inputNueva = document.getElementById("claveNueva");
        const inputConfirm = document.getElementById("claveConfirm");
        const btnGuardar = document.getElementById("btnGuardar");
        const btnVolver = document.getElementById("btnVolver");
        const msg = document.getElementById("mensaje");

        function mostrar(texto, color="red") {
            msg.style.color = color;
            msg.textContent = texto;
        }

        btnGuardar.addEventListener("click", async () => {

            const actual = inputActual.value.trim();
            const nueva = inputNueva.value.trim();
            const confirm = inputConfirm.value.trim();

            if (!actual || !nueva || !confirm) return mostrar("Completa todos los campos");
            if (nueva.length < 4) return mostrar("La nueva clave debe tener mínimo 4 caracteres");
            if (nueva !== confirm) return mostrar("Las claves no coinciden");

            // Obtener la clave actual desde Firestore
            const ref = doc(db, "usuarios", usuario);
            const snap = await getDoc(ref);

            if (!snap.exists()) {
                mostrar("Usuario no encontrado");
                return;
            }

            const datos = snap.data();

            if (datos.clave !== actual) {
                mostrar("Clave actual incorrecta");
                return;
            }

            // Actualizar la clave
            await updateDoc(ref, { clave: nueva });

            mostrar("✔ Clave actualizada correctamente", "green");

            setTimeout(() => {
                window.location.href = "dashboard.html";
            }, 1200);
        });

        btnVolver.addEventListener("click", () => {
            window.location.href = "dashboard.html";
        });

    });
</script>

<style>
body {
    margin: 0;
    background: #e9ecef;
    font-family: Arial;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}
.card {
    background: white;
    padding: 25px;
    width: 350px;
    border-radius: 12px;
    box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
}
input, button {
    width: 100%;
    padding: 14px;
    margin-top: 12px;
    border-radius: 8px;
    font-size: 16px;
}
button {
    cursor: pointer;
    border: none;
}
#btnGuardar { background: #3b5bff; color: white; }
#btnVolver { background: #adb5bd; color: white; }
button:hover { opacity: 0.92; }
#mensaje { margin-top: 14px; font-size: 15px; text-align: center; }
</style>
</head>

<body>
<div class="card">
    <h2 style="text-align:center;">Cambiar contraseña</h2>

    <input id="claveActual" type="password" placeholder="Clave actual">
    <input id="claveNueva" type="password" placeholder="Nueva clave">
    <input id="claveConfirm" type="password" placeholder="Confirmar nueva clave">

    <button id="btnGuardar">Guardar</button>
    <button id="btnVolver">Volver</button>

    <div id="mensaje"></div>
</div>
</body>
</html>
