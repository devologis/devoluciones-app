<script type="module">
  import { getFirestore, doc, getDoc, updateDoc } 
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { app } from "./firebase.js";

  const db = getFirestore(app);

  if (!localStorage.getItem("usuario")) {
    window.location.href = "index.html";
  }

  const usuarioId = localStorage.getItem("usuario");

  const claveActual = document.getElementById("claveActual");
  const claveNueva = document.getElementById("claveNueva");
  const claveConfirm = document.getElementById("claveConfirm");
  const btnCambiar = document.getElementById("btnCambiar");
  const btnVolver = document.getElementById("btnVolver");
  const mensaje = document.getElementById("mensaje");

  function mostrar(msj, color="red") {
    mensaje.style.color = color;
    mensaje.textContent = msj;
  }

  btnCambiar.addEventListener("click", async () => {
    const actual = claveActual.value.trim();
    const nueva = claveNueva.value.trim();
    const confirm = claveConfirm.value.trim();

    if (!actual || !nueva || !confirm) return mostrar("Completa todos los campos");
    if (nueva.length < 4) return mostrar("La nueva clave debe tener mínimo 4 caracteres");
    if (nueva !== confirm) return mostrar("La nueva clave no coincide");

    try {
      const ref = doc(db, "usuarios", usuarioId);
      const snap = await getDoc(ref);

      if (!snap.exists()) return mostrar("Usuario no encontrado");

      const data = snap.data();

      // ✅ Validar clave actual
      if (data.clave !== actual) return mostrar("❌ La clave actual es incorrecta");

      // ✅ Actualizar clave
      await updateDoc(ref, { clave: nueva });

      mostrar("✅ Clave actualizada con éxito", "green");

      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 1500);

    } catch (e) {
      mostrar("❌ Error al actualizar la clave");
      console.error(e);
    }
  });

  btnVolver.addEventListener("click", () => {
    const rol = localStorage.getItem("rol");
    if (rol === "admin") {
      window.location.href = "admin.html";
    } else {
      window.location.href = "dashboard.html";
    }
  });
</script>
