<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cambiar Clave</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f1f1f1; margin:0; padding:0; }
    .wrap { max-width:520px; margin:10px auto; padding:18px; text-align:center; }
    h1 { margin: 6px 0 20px; font-size:22px; }
    input {
      width:100%; padding:14px; margin:10px 0;
      border:1px solid #cfcfcf; border-radius:8px; font-size:16px;
    }
    .btn {
      width:100%; padding:16px; margin:14px 0; font-size:18px;
      border-radius:10px; border:1px solid #cfcfcf; background:#e8e8e8; cursor:pointer;
    }
    .btn-danger { background:#ffb3b3; border-color:#e6a0a0; }
    .msg { font-size:15px; margin-top:10px; }
  </style>

  <!-- Firebase Modular v10 -->
  <script type="module">
    import { db } from "./js/firebase.js";
    import { doc, getDoc, updateDoc } 
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    document.addEventListener("DOMContentLoaded", () => {

      // Si no hay sesiÃ³n, volver al login
      const usuario = localStorage.getItem("usuario");
      if (!usuario) {
        window.location.href = "index.html";
        return;
      }

      // Elementos HTML
      const claveActual = document.getElementById("claveActual");
      const claveNueva = document.getElementById("claveNueva");
      const claveConfirm = document.getElementById("claveConfirm");
      const btnCambiar = document.getElementById("btnCambiar");
      const btnVolver = document.getElementById("btnVolver");
      const mensaje = document.getElementById("mensaje");

      function mostrar(msj, color = "red") {
        mensaje.style.color = color;
        mensaje.textContent = msj;
      }

      // ðŸ”™ BotÃ³n Volver
      btnVolver.addEventListener("click", () => {
        window.location.href = "dashboard.html";
      });

      // ðŸ” Cambiar clave
      btnCambiar.addEventListener("click", async () => {

        const actual = claveActual.value.trim();
        const nueva = claveNueva.value.trim();
        const confirm = claveConfirm.value.trim();

        if (!actual || !nueva || !confirm)
          return mostrar("Completa todos los campos");

        if (nueva.length < 4)
          return mostrar("La nueva clave debe tener mÃ­nimo 4 caracteres");

        if (nueva !== confirm)
          return mostrar("La nueva clave no coincide");

        try {
          // Traer datos del usuario
          const ref = doc(db, "usuarios", usuario);
          const snap = await getDoc(ref);

          if (!snap.exists())
            return mostrar("Usuario no encontrado");

          const data = snap.data();

          // Validar clave actual
          if (data.clave !== actual)
            return mostrar("Clave actual incorrecta");

          // Actualizar clave
          await updateDoc(ref, { clave: nueva });

          mostrar("âœ” Clave actualizada correctamente", "green");

          setTimeout(() => {
            window.location.href = "dashboard.html";
          }, 1500);

        } catch (error) {
          console.error("Error cambiando clave:", error);
          mostrar("Error actualizando la clave.");
        }

      }); // fin cambiar clave

    }); // fin DOMContentLoaded

  </script>
</head>

<body>

  <div class="wrap">
    <h1>Cambiar Clave</h1>

    <input id="claveActual" type="password" placeholder="Clave Actual">
    <input id="claveNueva" type="password" placeholder="Nueva Clave">
    <input id="claveConfirm" type="password" placeholder="Confirmar Nueva Clave">

    <button id="btnCambiar" class="btn">Guardar Cambios</button>
    <button id="btnVolver" class="btn btn-danger">Volver</button>

    <div id="mensaje" class="msg"></div>
  </div>

</body>
</html>
