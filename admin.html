<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Administrar Usuarios</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
        body { font-family: Arial, sans-serif; background:#f1f1f1; margin:0; padding:0; }
        .wrap { max-width:540px; margin:10px auto; padding:14px; }
        h1 { text-align:center; margin:10px 0 18px; font-size:22px; }

        table { width:100%; border-collapse:collapse; font-size:16px; background:white; }
        th, td { border:1px solid #ccc; padding:8px; text-align:center; }
        th { background:#e3e3e3; }

        .btn {
          width:100%; padding:14px; margin:12px 0; font-size:18px; border-radius:10px;
          border:1px solid #cfcfcf; background:#e8e8e8; cursor:pointer;
        }

        .icon-btn { cursor:pointer; font-size:20px; }

        .modal-bg {
            position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center;
        }
        .modal {
            background:white; width:92%; max-width:340px; padding:18px; border-radius:10px;
        }
        .btn-danger { background:#ffb3b3; }
    </style>
</head>
<body>

<div class="wrap">
    <h1>Administraci√≥n de Usuarios</h1>

    <button class="btn" onclick="abrirCrear()">‚ûï Crear Usuario</button>

    <table>
        <thead>
            <tr>
                <th>Usuario</th>
                <th>Nombre</th>
                <th>Rol</th>
                <th>Modificar</th>
            </tr>
        </thead>
        <tbody id="tablaUsuarios"></tbody>
    </table>

    <button class="btn btn-danger" onclick="window.location.href='dashboard.html'">üîô Volver</button>
</div>

<!-- MODAL -->
<div id="modalBG" class="modal-bg">
    <div class="modal">
        <h2 id="modalTitulo">Editar Usuario</h2>

        <label>Usuario</label>
        <input type="text" id="mUsuario" disabled>

        <label>Nombre</label>
        <input type="text" id="mNombre">

        <label>Rol</label>
        <select id="mRol">
            <option value="normal">Normal</option>
            <option value="admin">Admin</option>
            <option value="auditor">Auditor</option>
        </select>

        <button class="btn" onclick="guardarCambios()">üíæ Guardar Cambios</button>
        <button class="btn" onclick="resetClave()">üîë Resetear Clave</button>
        <button class="btn btn-danger" onclick="eliminarUsuario()">üóë Eliminar Usuario</button>
        <button class="btn" onclick="cerrarModal()">‚ùå Cerrar</button>
    </div>
</div>

<!-- ‚úÖ Firebase Firestore -->
<script type="module">
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot }
    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { app } from "./js/firebase.js";

    const db = getFirestore(app);

    // ‚úÖ Bloqueo de acceso si NO es admin
    const rol = localStorage.getItem("rol");
    if (rol !== "admin") {
        alert("‚ùå Acceso denegado");
        window.location.href = "dashboard.html";
    }

    const tabla = document.getElementById("tablaUsuarios");
    const modalBG = document.getElementById("modalBG");
    let usuarioActual = "";

    // ‚úÖ Cargar usuarios existentes
    function cargarUsuarios() {
        const usuariosRef = collection(db, "usuarios");
        onSnapshot(usuariosRef, (snapshot) => {
            tabla.innerHTML = "";
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                tabla.innerHTML += `
                    <tr>
                        <td>${docSnap.id}</td>
                        <td>${data.nombre || ""}</td>
                        <td>${data.rol || "normal"}</td>
                        <td><span class="icon-btn" onclick="abrirEditar('${docSnap.id}')">‚úèÔ∏è</span></td>
                    </tr>
                `;
            });
        });
    }
    cargarUsuarios();

    // ‚úÖ Abrir modal para editar
    window.abrirEditar = async (id) => {
        usuarioActual = id;
        const docSnap = await getDoc(doc(db, "usuarios", id));
        const data = docSnap.data();

        document.getElementById("modalTitulo").textContent = "Editar Usuario";
        document.getElementById("mUsuario").value = id;
        document.getElementById("mNombre").value = data.nombre;
        document.getElementById("mRol").value = data.rol;

        modalBG.style.display = "flex";
    };

    // ‚úÖ Guardar cambios o crear usuario
    window.guardarCambios = async () => {
        const usuario = document.getElementById("mUsuario").value.trim();
        const nombre = document.getElementById("mNombre").value.trim();
        const rol = document.getElementById("mRol").value;

        if (usuarioActual === "") {
            const clave = prompt("Ingrese clave inicial:");
            if (!clave) return;

            await setDoc(doc(db, "usuarios", usuario), {
                nombre,
                rol,
                clave
            });
            alert("‚úÖ Usuario creado");
        } else {
            await updateDoc(doc(db, "usuarios", usuarioActual), {
                nombre,
                rol
            });
            alert("‚úÖ Cambios guardados");
        }

        cerrarModal();
    };

    // ‚úÖ Reset clave
    window.resetClave = async () => {
        const nueva = prompt("Ingrese nueva clave:");
        if (!nueva) return;

        await updateDoc(doc(db, "usuarios", usuarioActual), { clave: nueva });
        alert("‚úÖ Clave actualizada");
    };

    // ‚úÖ Eliminar usuario
    window.eliminarUsuario = async () => {
        if (!confirm("¬øEliminar este usuario?")) return;

        await deleteDoc(doc(db, "usuarios", usuarioActual));
        alert("‚úÖ Usuario eliminado");
        cerrarModal();
    };

    // ‚úÖ Crear usuario
    window.abrirCrear = () => {
        usuarioActual = "";
        document.getElementById("modalTitulo").textContent = "Crear Usuario";
        document.getElementById("mUsuario").disabled = false;
        document.getElementById("mUsuario").value = "";
        document.getElementById("mNombre").value = "";
        document.getElementById("mRol").value = "normal";
        modalBG.style.display = "flex";
    };

    // ‚úÖ Cerrar modal
    window.cerrarModal = () => {
        modalBG.style.display = "none";
        document.getElementById("mUsuario").disabled = true;
    };
</script>

</body>
</html>
