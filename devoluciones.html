<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Devoluciones</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f2f2f2;
            padding: 15px;
            max-width: 100%;
        }
        h2 { text-align: center; }
        form {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        label { display: block; margin-top: 10px; font-size: 15px; }
        input {
            width: 100%;
            padding: 10px;
            font-size: 18px;
            margin-top: 3px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .botones {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            flex: 1;
            padding: 12px;
            font-size: 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #e0e0e0;
        }
        #btn_finalizar { background: #90caf9; }
        #btn_cerrar { background: #ffb3b3; }
    </style>
</head>

<body>

<h2>Registro de Devoluciones</h2>

<form id="formDev">
    <label>N¬∞ Factura</label>
    <input type="number" id="factura" autocomplete="off" />

    <label>C√≥digo</label>
    <input type="text" id="codigo" autocomplete="off" />

    <label>Lote</label>
    <input type="text" id="lote" autocomplete="off" />

    <label>Fecha Vencimiento (MM/AAAA)</label>
    <input type="text" id="fecha_vto" autocomplete="off" placeholder="MM/AAAA" />

    <label>Cantidad Buen Estado</label>
    <input type="number" id="cant_buen" />

    <label>Aver√≠as</label>
    <input type="number" id="averias" />

    <label>Total Recibido</label>
    <input type="number" id="total" readonly />

    <div class="botones">
        <button type="button" id="btn_siguiente">Siguiente c√≥digo</button>
        <button type="button" id="btn_finalizar">Finalizar factura</button>
        <button type="button" id="btn_cerrar">Cerrar Sesi√≥n</button>
    </div>
</form>

<script type="module">

import { db } from "../js/firebase.js";
import { addDoc, collection } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// ===============================
// üß© VALIDAR LOGIN
// ===============================
if (!localStorage.getItem("usuario")) {
    window.location.href = "index.html";
}

const usuarioActual = localStorage.getItem("usuario");

// ===============================
// üî¢ CALCULAR TOTAL
// ===============================
function calcTotal() {
    let b = Number(document.getElementById("cant_buen").value);
    let a = Number(document.getElementById("averias").value);
    document.getElementById("total").value = b + a;
}

document.getElementById("cant_buen").addEventListener("input", calcTotal);
document.getElementById("averias").addEventListener("input", calcTotal);

// ===============================
// üíæ GUARDAR CODIGO (NO FACTURA)
// ===============================
async function guardarCodigo() {

    let factura = document.getElementById("factura").value.trim();
    let codigo = document.getElementById("codigo").value.trim();
    let lote = document.getElementById("lote").value.trim();
    let fecha_vto = document.getElementById("fecha_vto").value.trim();
    let cant_buen = Number(document.getElementById("cant_buen").value);
    let averias = Number(document.getElementById("averias").value);
    let total = cant_buen + averias;

    if (!factura || !codigo || !lote || !fecha_vto) {
        alert("Complete todos los campos obligatorios.");
        return false;
    }

    await addDoc(collection(db, "devoluciones"), {
        factura,
        codigo,
        lote,
        fecha_vto,
        cant_buen,
        averias,
        total,
        usuario_registra: usuarioActual,
        fecha_registro: new Date()
    });

    return true;
}

// ===============================
// ‚û°Ô∏è BOT√ìN SIGUIENTE C√ìDIGO
// ===============================
document.getElementById("btn_siguiente").addEventListener("click", async () => {

    let ok = await guardarCodigo();
    if (!ok) return;

    alert("C√≥digo guardado. Ingrese el siguiente.");

    // Limpia solo campos del c√≥digo
    document.getElementById("codigo").value = "";
    document.getElementById("lote").value = "";
    document.getElementById("fecha_vto").value = "";
    document.getElementById("cant_buen").value = "";
    document.getElementById("averias").value = "";
    document.getElementById("total").value = "";
});

// ===============================
// ‚úÖ FINALIZAR FACTURA
// ===============================
document.getElementById("btn_finalizar").addEventListener("click", async () => {

    let ok = await guardarCodigo();
    if (!ok) return;

    let cajas = prompt("Ingrese cantidad total de cajas del pedido:");

    if (!cajas || isNaN(cajas)) {
        alert("Debe ingresar un n√∫mero v√°lido.");
        return;
    }

    // Guardamos cajas asociadas a la factura
    await addDoc(collection(db, "facturas"), {
        factura: document.getElementById("factura").value.trim(),
        cajas: Number(cajas),
        usuario_registra: usuarioActual,
        fecha_registro: new Date()
    });

    alert("Factura finalizada correctamente.");

    // Limpiar todo
    document.getElementById("formDev").reset();
});

// ===============================
// üö™ Cerrar sesi√≥n
// ===============================
document.getElementById("btn_cerrar").addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "index.html";
});

</script>

</body>
</html>


